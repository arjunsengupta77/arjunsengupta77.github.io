from flask import Blueprint, render_template, request
from app.models import Attribute, Feed, System

bp = Blueprint('main', __name__)

@bp.route('/attribute-details')
def attribute_details():
    attribute_id = request.args.get('attribute_id')
    
    # If no attribute_id is provided, return an error or a message
    if not attribute_id:
        return "Attribute ID is required", 400
    
    # Query the attribute based on the attribute_id
    attribute = Attribute.query.filter_by(ATTRIBUTE_ID=attribute_id).first()
    
    if not attribute:
        return f"Attribute with ID {attribute_id} not found", 404
    
    # Query the feeds that contain the given attribute
    feeds = Feed.query.filter(Feed.ATTRIBUTES_CONTAINED.like(f"%{attribute_id}%")).all()
    
    # Query the origin system from the systems table
    system = System.query.filter_by(SYSTEM_ID=attribute.ORIGIN_SYSTEM).first()

    # Handle the addition of external links (if passed via the form)
    if request.method == 'POST':
        external_links = request.form.getlist('external_links')
        # Logic to store or process external links can be added here

    return render_template('attribute_details.html', 
                           attribute=attribute, 
                           system=system, 
                           feeds=feeds)